---
# AI Box - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Ansible
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ

- name: "AI Box - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"
  hosts: localhost
  connection: local
  become: yes
  vars_files:
    - vars/main.yml
  
  tasks:
    - name: "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π"
      include_tasks: tasks/check-requirements.yml
    
    - name: "üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ Docker Compose"
      include_tasks: tasks/install-docker.yml
      when: ansible_facts['os_family'] == "Debian" or ansible_facts['os_family'] == "RedHat"
    
    - name: "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ aibox_home }}/data"
        - "{{ aibox_home }}/logs"
        - "{{ aibox_home }}/config"
        - "{{ aibox_home }}/backups"
    
    - name: "‚öôÔ∏è –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: '0644'
      loop:
        - { src: "docker-compose.local.yml.j2", dest: "{{ aibox_home }}/docker-compose.yml" }
        - { src: "prometheus.yml.j2", dest: "{{ aibox_home }}/config/prometheus.yml" }
        - { src: "grafana-datasources.yml.j2", dest: "{{ aibox_home }}/config/grafana-datasources.yml" }
    
    - name: "üîë –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
      template:
        src: ".env.j2"
        dest: "{{ aibox_home }}/.env"
        mode: '0600'
    
    - name: "üì• –ó–∞–≥—Ä—É–∑–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤"
      docker_image:
        name: "{{ item }}"
        source: pull
      loop:
        - "ollama/ollama:latest"
        - "postgres:15"
        - "qdrant/qdrant:latest"
        - "prom/prometheus:latest"
        - "grafana/grafana:latest"
        - "nginx:alpine"
      
    - name: "üèóÔ∏è –°–±–æ—Ä–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ AI Box"
      docker_image:
        name: "{{ item.name }}"
        build:
          path: "{{ item.path }}"
          dockerfile: "{{ item.dockerfile }}"
        source: build
        force_source: yes
      loop:
        - { name: "aibox/gateway", path: ".", dockerfile: "Dockerfile.gateway" }
        - { name: "aibox/rag", path: "./services/rag", dockerfile: "Dockerfile" }
        - { name: "aibox/agents", path: "./services/agents", dockerfile: "Dockerfile" }
    
    - name: "üöÄ –ó–∞–ø—É—Å–∫ AI Box —Å –ø–æ–º–æ—â—å—é Docker Compose"
      docker_compose:
        project_src: "{{ aibox_home }}"
        state: present
        pull: yes
    
    - name: "‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤"
      uri:
        url: "http://localhost:{{ gateway_port }}/health"
        method: GET
        status_code: 200
      register: health_check
      retries: 30
      delay: 10
      until: health_check.status == 200
    
    - name: "üéØ –ó–∞–≥—Ä—É–∑–∫–∞ AI –º–æ–¥–µ–ª–µ–π –≤ Ollama"
      uri:
        url: "http://localhost:{{ ollama_port }}/api/pull"
        method: POST
        body_format: json
        body:
          name: "{{ item }}"
      loop: "{{ ollama_models }}"
      ignore_errors: yes
    
    - name: "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
      uri:
        url: "http://localhost:{{ gateway_port }}/api/services/status"
        method: GET
      register: services_status
    
    - name: "üìä –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏"
      debug:
        msg:
          - "üéâ AI Box —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –ª–æ–∫–∞–ª—å–Ω–æ!"
          - "üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:{{ gateway_port }}"
          - "üìö API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:{{ gateway_port }}/docs"
          - "üìä Grafana: http://localhost:{{ grafana_port }} (admin/admin)"
          - "üîç Prometheus: http://localhost:{{ prometheus_port }}"
          - "‚ù§Ô∏è  –°—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è: http://localhost:{{ gateway_port }}/health"